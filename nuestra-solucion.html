<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo T√©cnica - ProSmart Factories</title>

    <!-- ORIGINAL DEPENDENCIES FROM INDEX.HTML -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <!-- APP DEPENDENCIES -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            /* === COLOR PRIMITIVES === */
            --color-navy-950: #0a0f1c;
            --color-navy-900: #111827;
            --color-navy-800: #1a2332;
            --color-orange-500: #f97316;
            --color-orange-600: #ea580c;
            --color-red-500: #ef4444;
            --color-green-500: #22c55e;
            --color-slate-400: #94a3b8;
            --color-slate-200: #f8fafc;

            /* === SEMANTIC TOKENS === */
            --bg-primary: var(--color-navy-950);
            --bg-secondary: var(--color-navy-900);
            --surface-elevated: var(--color-navy-800);
            --text-primary: var(--color-slate-200);
            --text-secondary: var(--color-slate-400);
            --brand-primary: var(--color-orange-500);
            --brand-primary-hover: var(--color-orange-600);
            --primary: var(--brand-primary);
            --danger: var(--color-red-500);

            --border: rgba(255, 255, 255, 0.1);

            /* WhatsApp */
            --wa-header: #202c33;
            --wa-green: #25D366;
            --wa-bubble-out: #005c4b;
            --wa-bubble-in: #202c33;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            margin: 0;
        }

        /* --- BACKGROUND --- */
        .grid-container {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            perspective: 1000px;
        }

        .grid-lines {
            position: absolute;
            inset: -50%;
            width: 200%;
            height: 200%;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: rotateX(60deg) translateY(-100px);
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% {
                transform: rotateX(60deg) translateY(0);
            }

            100% {
                transform: rotateX(60deg) translateY(60px);
            }
        }

        /* --- HEADER --- */
        nav {
            padding: 20px 40px;
            background: rgba(10, 15, 28, 0.7);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: white;
            letter-spacing: 2px;
            text-decoration: none;
        }

        .logo span {
            color: var(--primary);
        }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .back-link:hover {
            color: var(--primary);
        }

        /* --- MAIN LAYOUT --- */
        .demo-container {
            min-height: 100vh;
            display: grid;
            grid-template-columns: 1fr 1fr;
            max-width: 1500px;
            margin: 0 auto;
            padding: 120px 40px 40px;
            gap: 60px;
            align-items: center;
        }

        /* --- TEXT SIDE --- */
        .text-side {
            animation: slideIn 0.8s ease-out;
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(3rem, 5vw, 5rem);
            letter-spacing: 2px;
            line-height: title;
            margin-bottom: 24px;
            background: linear-gradient(135deg, white 0%, var(--primary) 60%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .text-side p {
            font-size: 1.15rem;
            color: var(--text-secondary);
            margin-bottom: 40px;
            max-width: 550px;
        }

        /* --- BUTTONS --- */
        .btn-brand {
            background: linear-gradient(135deg, var(--primary), var(--color-orange-600));
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            box-shadow: 0 4px 20px rgba(249, 115, 22, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }

        .btn-brand:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.5);
        }

        /* --- PHONE MOCKUP AREA --- */
        .mockup-3d-wrapper {
            position: relative;
            width: 100%;
            height: 800px;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1500px;
            /* Enhanced depth */
        }

        #canvas-container {
            position: absolute;
            inset: 0;
            z-index: 1;
        }

        /* --- CHAT INTERFACE --- */
        .chat-overlay {
            width: 300px;
            height: 600px;
            background: #0b141a;
            border-radius: 35px;
            /* Match phone frame */
            overflow: hidden;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            /* Transform is handled by JS */
        }

        .wa-header {
            background: var(--wa-header);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .wa-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), #ffffff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .wa-body {
            flex: 1;
            background-color: #0d141b;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            opacity: 0.95;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .wa-msg {
            max-width: 80%;
            padding: 10px 14px;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
            border-radius: 8px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        }

        .wa-msg.received {
            background: var(--wa-bubble-in);
            color: white;
            align-self: flex-start;
            border-top-left-radius: 0;
        }

        .wa-msg.sent {
            background: var(--wa-bubble-out);
            color: white;
            align-self: flex-end;
            border-top-right-radius: 0;
        }

        .wa-footer {
            background: var(--wa-header);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wa-input-container {
            flex: 1;
            background: #2a3942;
            border-radius: 20px;
            padding: 8px 16px;
        }

        .wa-input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            outline: none;
            font-size: 1rem;
        }

        .wa-send {
            background: var(--wa-green);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .wa-send:hover {
            opacity: 0.9;
        }

        /* --- AUTH MODAL --- */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-box {
            background: #111b21;
            border: 1px solid var(--border);
            padding: 40px;
            border-radius: 24px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-input {
            width: 100%;
            background: #202c33;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
            border-radius: 12px;
            color: white;
            margin-bottom: 12px;
            font-family: inherit;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .link {
            color: var(--primary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: 0.2s;
        }

        .link:hover {
            text-decoration: underline;
        }

        @media (max-width: 900px) {
            .demo-container {
                grid-template-columns: 1fr;
                padding-top: 100px;
                text-align: center;
            }

            .text-side p {
                margin-left: auto;
                margin-right: auto;
            }

            .mockup-3d-wrapper {
                height: 600px;
            }
        }
    </style>
</head>

<body>
    <div class="grid-container">
        <div class="grid-lines"></div>
    </div>

    <nav>
        <a href="index.html" class="logo">PROSMART <span>FACTORIES</span></a>
        <a href="index.html" class="back-link">‚Üê Inicio</a>
    </nav>

    <div class="demo-container">
        <div class="text-side">
            <span
                style="color: var(--primary); font-weight:800; letter-spacing:2px; font-size:0.85rem; text-transform:uppercase; margin-bottom:10px; display:block;">
                Acceso Exclusivo Demo 2.0
            </span>
            <h1 class="section-title">ASISTENTE T√âCNICO<br>INDUSTRIAL IA</h1>
            <p>
                Sube tus manuales t√©cnicos y deja que nuestra IA resuelva dudas de mantenimiento
                y operaci√≥n al instante, directamente desde la interfaz que ya conoces.
            </p>

            <input type="file" id="pdf-upload" accept="application/pdf" style="display:none"
                onchange="handleFile(event)">
            <button class="btn-brand" id="upload-btn" onclick="document.getElementById('pdf-upload').click()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4" />
                    <polyline points="17 8 12 3 7 8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
                SUBIR MANUAL (PDF)
            </button>
        </div>

        <div class="mockup-3d-wrapper">
            <!-- Three.js Canvas -->
            <div id="canvas-container"></div>

            <!-- WhatsApp Interface Overlay -->
            <div class="chat-overlay" id="chat-overlay">
                <div class="wa-header">
                    <div class="wa-avatar">ü§ñ</div>
                    <div class="wa-status">
                        <h3>ProSmart AI</h3>
                        <p>‚óè en l√≠nea</p>
                    </div>
                </div>
                <div class="wa-body" id="chat-box">
                    <div class="wa-msg received">
                        Bienvenido. Sube un manual t√©cnico para comenzar el an√°lisis y resolver tus dudas operativas.
                    </div>
                </div>
                <div class="wa-footer">
                    <input type="file" id="chat-image-upload" accept="image/*" style="display:none"
                        onchange="handleImageSelect(event)">
                    <button class="wa-send" style="background:transparent; margin-right:5px;"
                        onclick="document.getElementById('chat-image-upload').click()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z">
                            </path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </button>
                    <div class="wa-input-container">
                        <input type="text" class="wa-input" id="chat-input" placeholder="Escribe un mensaje..."
                            disabled>
                    </div>
                    <button class="wa-send" onclick="sendMsg()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13" />
                            <polyline points="22 2 15 22 11 13 2 9 22 2" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="modal active">
        <div class="modal-box">
            <h2
                style="color:white; font-family:'Bebas Neue'; font-size:2.5rem; letter-spacing:2px; margin-bottom:20px;">
                ACCESO DEMO</h2>

            <div id="step-login">
                <input type="email" id="email" class="modal-input" placeholder="Email corporativo">
                <input type="password" id="pass" class="modal-input" placeholder="Contrase√±a">
                <button class="btn-brand" onclick="login()" style="width:100%; margin-top:20px;">ENTRAR</button>
                <div style="margin-top:15px;">
                    <span id="toggle-link" class="link" onclick="toggleMode()">Registrarse</span> |
                    <span class="link" onclick="showRecover()">Recuperar Clave</span>
                </div>
            </div>
        </div>

        <div id="step-verify" style="display:none;">
            <p style="color:#ccc">C√≥digo recibido en email:</p>
            <input type="text" id="otp" class="modal-input" style="text-align:center; letter-spacing:4px;"
                placeholder="XXXXXX">
            <button class="btn-brand" onclick="verify()" style="width:100%; margin-top:20px;">VERIFICAR</button>
            <p class="link" onclick="resendOtp()"
                style="margin-top:20px; font-size:0.8rem; color:var(--text-secondary);">
                ¬øNo lleg√≥? <span style="color:var(--primary); text-decoration:underline;">Reenviar C√≥digo</span>
            </p>
            <p class="link" onclick="showLogin()" style="margin-top:10px; font-size:0.8rem;">Volver</p>
        </div>

        <div id="step-recover" style="display:none;">
            <p style="color:#ccc">Tu email:</p>
            <input type="email" id="rec-email" class="modal-input">
            <p style="color:#ccc; margin-top:10px;">Nueva Contrase√±a:</p>
            <input type="password" id="rec-newp1" class="modal-input">
            <input type="password" id="rec-newp2" class="modal-input" placeholder="Confirmar">
            <button class="btn-brand" onclick="initiateRecovery()" style="width:100%; margin-top:20px;">ACEPTAR</button>
            <p class="link" onclick="showLogin()" style="margin-top:15px">Cancelar</p>
        </div>

        <div id="step-recover-verify" style="display:none;">
            <h3 style="color:var(--primary); font-family:'Bebas Neue'; letter-spacing:1px; margin-bottom:10px;">
                VERIFICACI√ìN SEGURIDAD</h3>
            <p style="color:#ccc; font-size:0.9rem;">Hemos enviado un c√≥digo a tu email.<br>Introd√∫celo para confirmar
                el cambio.</p>
            <input type="text" id="rec-otp" class="modal-input"
                style="text-align:center; letter-spacing:4px; margin-top:15px;" placeholder="XXXXXX">
            <button class="btn-brand" onclick="completeRecovery()" style="width:100%; margin-top:20px;">VERIFICAR Y
                CAMBIAR</button>
            <p class="link" onclick="showRecover()" style="margin-top:15px">Volver</p>
        </div>

        <div id="step-newpass" style="display:none;">
            <p style="color:#ccc">Nueva Contrase√±a:</p>
            <input type="password" id="new-p1" class="modal-input">
            <input type="password" id="new-p2" class="modal-input" placeholder="Confirmar">
            <button class="btn-brand" onclick="updatePass()" style="width:100%; margin-top:20px;">GUARDAR</button>
        </div>
    </div>
    </div>

    <script>
        // --- GLOBAL INITIALIZATION ---
        const SUPABASE_PROJECT_URL = "https://kgcdeqsvqneyysubmnch.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtnY2RlcXN2cW5leXlzdWJtbmNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MDYxNDIsImV4cCI6MjA4NTI4MjE0Mn0.H9tZkaaiqTsYOD10G_eZDZe4C78ZdxGrXO5C5zYHGJ0";

        // Use a unique name to avoid collisions
        const supaClient = supabase.createClient(SUPABASE_PROJECT_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let isSignUpMode = false; // Renamed from 'signup'

        // --- AUTH LISTENERS ---
        supaClient.auth.onAuthStateChange((evt, session) => {
            console.log("Auth Event:", evt);
            if (evt === 'SIGNED_IN') {
                currentUser = session.user;
                document.getElementById('auth-modal').classList.remove('active');
                document.getElementById('chat-input').disabled = false;
            } else if (evt === 'PASSWORD_RECOVERY') {
                document.getElementById('auth-modal').classList.add('active');
                show('step-newpass');
            } else {
                if (!window.location.hash.includes('type=recovery')) {
                    document.getElementById('auth-modal').classList.add('active');
                }
            }
        });

        // --- FUNCTIONS ---
        async function login() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            try {
                if (isSignUpMode) {
                    const { error } = await supaClient.auth.signUp({ email: e, password: p });
                    if (error) throw error;
                    show('step-verify');
                    alert("Revisa tu email (C√≥digo).");
                } else {
                    const { error } = await supaClient.auth.signInWithPassword({ email: e, password: p });
                    if (error) throw error;
                }
            } catch (err) { alert(err.message); }
        }

        async function verify() {
            const e = document.getElementById('email').value;
            const t = document.getElementById('otp').value.trim();
            if (!t) return alert("Ingresa el c√≥digo de 6 d√≠gitos.");

            const btn = document.querySelector('#step-verify button');
            const originalText = btn.innerText;
            btn.innerText = "VERIFICANDO..."; btn.disabled = true;

            try {
                let { data, error } = await supaClient.auth.verifyOtp({ email: e, token: t, type: 'signup' });

                // Fallback for different verification types if signup fails but code is valid (e.g. magiclink)
                if (error) {
                    console.log("Signup verify failed, trying magiclink/recovery...");
                    const { data: d2, error: e2 } = await supaClient.auth.verifyOtp({ email: e, token: t, type: 'magiclink' });
                    if (e2) {
                        const { data: d3, error: e3 } = await supaClient.auth.verifyOtp({ email: e, token: t, type: 'recovery' });
                        if (e3) throw error; // Throw original error if all fail
                    }
                }

                // Success
                alert("!Verificado Exitosamente!");
                document.getElementById('auth-modal').classList.remove('active');

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        }

        async function resendOtp() {
            const e = document.getElementById('email').value;
            if (!e) return alert("Email requerido");

            try {
                const { error } = await supaClient.auth.resend({ type: 'signup', email: e });
                if (error) throw error;
                alert("C√≥digo reenviado. Revisa SPAM.");
            } catch (err) {
                alert("Error al reenviar: " + err.message);
            }
        }

        let pendingRecoveryPass = null;

        async function initiateRecovery() {
            const e = document.getElementById('rec-email').value;
            const p1 = document.getElementById('rec-newp1').value;
            const p2 = document.getElementById('rec-newp2').value;

            if (!e || !p1) return alert("Completa todos los campos");
            if (p1 !== p2) return alert("Las contrase√±as no coinciden");

            const btn = document.querySelector('#step-recover button');
            const originalText = btn.innerText;
            btn.innerText = "ENVIANDO..."; btn.disabled = true;

            try {
                // Just trigger the OTP code email
                const { error } = await supaClient.auth.resetPasswordForEmail(e);
                if (error) throw error;

                pendingRecoveryPass = p1; // Store for next step
                alert("C√≥digo enviado a tu correo.");
                show('step-recover-verify');
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        }

        async function completeRecovery() {
            const e = document.getElementById('rec-email').value;
            const t = document.getElementById('rec-otp').value.trim();

            if (!t) return alert("Ingresa el c√≥digo");

            const btn = document.querySelector('#step-recover-verify button');
            btn.innerText = "PROCESANDO..."; btn.disabled = true;

            try {
                // 1. Verify OTP -> Gets Session
                const { data, error } = await supaClient.auth.verifyOtp({ email: e, token: t, type: 'recovery' });
                if (error) throw error;

                // 2. Update User with new password
                const { error: upError } = await supaClient.auth.updateUser({ password: pendingRecoveryPass });
                if (upError) throw upError;

                alert("¬°Contrase√±a actualizada correctamente! Iniciando sesi√≥n...");

                // 3. User is now logged in via verifyOtp, just close modal
                document.getElementById('auth-modal').classList.remove('active');

            } catch (err) {
                alert("Error al verificar: " + err.message);
            } finally {
                btn.innerText = "VERIFICAR Y CAMBIAR"; btn.disabled = false;
            }
        }

        /* Legacy updatePass removed as it's merged into completeRecovery */

        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // GSAP Animations
        window.onload = () => {
            gsap.from(".section-title", { y: 50, opacity: 0, duration: 1, ease: "power4.out" });
            gsap.from(".text-side p", { y: 30, opacity: 0, duration: 1, delay: 0.2, ease: "power4.out" });
            gsap.from(".btn-brand", { scale: 0.9, opacity: 0, duration: 0.8, delay: 0.4, ease: "back.out(1.7)" });
        };

        // --- THREE.JS MOCKUP ---
        let scene, camera, renderer, phone;

        function init3D() {
            const container = document.getElementById('canvas-container');
            if (!container) return;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 6;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Lighting setup for "premium" look
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const light1 = new THREE.DirectionalLight(0xffffff, 1);
            light1.position.set(5, 5, 5);
            scene.add(light1);

            const light2 = new THREE.PointLight(0xf97316, 0.5);
            light2.position.set(-5, -5, 2);
            scene.add(light2);

            // Phone Body
            const phoneGroup = new THREE.Group();

            const bodyGeom = new THREE.BoxGeometry(2.4, 4.8, 0.25);
            const bodyMat = new THREE.MeshPhysicalMaterial({
                color: 0x0a0a0a,
                metalness: 0.9,
                roughness: 0.2,
                clearcoat: 1.0
            });
            phone = new THREE.Mesh(bodyGeom, bodyMat);
            phoneGroup.add(phone);

            // Frame (Simulating metallic edges)
            const frameGeom = new THREE.BoxGeometry(2.45, 4.85, 0.2);
            const frameMat = new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 1, roughness: 0.3 });
            const frame = new THREE.Mesh(frameGeom, frameMat);
            frame.position.z = -0.05;
            phoneGroup.add(frame);

            // Notch / Dynamic Island
            const notchGeom = new THREE.CapsuleGeometry(0.1, 0.4, 4, 8);
            const notchMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
            const notch = new THREE.Mesh(notchGeom, notchMat);
            notch.rotation.z = Math.PI / 2;
            notch.position.set(0, 2.15, 0.13);
            phoneGroup.add(notch);

            scene.add(phoneGroup);
            phone = phoneGroup; // Reference the group for rotation

            function animate() {
                requestAnimationFrame(animate);
                const time = Date.now() * 0.001;

                // Controlled rotation with subtle movement
                phone.rotation.y = Math.sin(time * 0.5) * 0.15;
                phone.rotation.x = Math.cos(time * 0.5) * 0.05;

                renderer.render(scene, camera);
                updateOverlayPosition();
            }
            animate();
        }

        function updateOverlayPosition() {
            const overlay = document.getElementById('chat-overlay');
            if (!phone || !overlay) return;

            // Apply tilt to HTML overlay to match 3D rotation
            const ry = phone.rotation.y * 20; // Scale factor for visual tilt
            const rx = -phone.rotation.x * 20;
            overlay.style.transform = `rotateY(${ry}deg) rotateX(${rx}deg) translateZ(50px)`;
        }

        function setTyping(isTyping) {
            const status = document.querySelector('.wa-status p');
            status.innerText = isTyping ? 'escribiendo...' : '‚óè en l√≠nea';
            status.style.color = isTyping ? '#fff' : 'var(--wa-green)';
        }

        window.addEventListener('resize', () => {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        init3D();

        async function handleFile(e) {
            const f = e.target.files[0];
            if (!f || !currentUser) return;

            const btn = document.getElementById('upload-btn');
            const originalTxt = btn.innerHTML;
            btn.innerHTML = "ANALIZANDO CON AWS..."; btn.disabled = true;

            try {
                addMsg(`Subiendo documento: ${f.name}`, 'sent');

                const formData = new FormData();
                formData.append('pdf', f);
                formData.append('userId', currentUser.id);

                // Call the new monolithic backend
                const { data, error } = await supaClient.functions.invoke('process_pdf', {
                    body: formData,
                    // Header for FormData is usually auto-set, but supabase-js invoke might need standard fetch for file upload nicely
                    // Actually, supaClient.functions.invoke with FormData works if we don't set Content-Type manually
                });

                if (error) throw error;
                if (data.error) throw new Error(data.error);

                addMsg("‚úÖ An√°lisis completado. El documento ha sido procesado con inteligencia artificial avanzada.", 'received');
                addMsg("¬øQu√© te gustar√≠a saber sobre el documento?", 'received');

            } catch (err) {
                console.error("Upload Error:", err);
                addMsg("‚ùå Error al procesar: " + (err.message || err.error_description || "Error desconocido"), 'received');
            } finally {
                btn.innerHTML = originalTxt; btn.disabled = false;
            }
        }

        // Global variable to hold image data
        let selectedImageBase64 = null;

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Simple validation
            if (file.size > 5 * 1024 * 1024) {
                alert("La imagen es muy grande (Max 5MB)");
                return;
            }

            const reader = new FileReader();
            reader.onloadend = () => {
                selectedImageBase64 = reader.result;
                // Show a preview or indication in the input area? 
                // For now, just a placeholder in chat box or change button color
                document.querySelector('.wa-send svg').style.stroke = 'var(--primary)'; // Indicate active
                addMsg(`üì∑ Imagen seleccionada: ${file.name}`, 'sent');
            };
            reader.readAsDataURL(file);
        }

        async function sendMsg() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();

            // Allow sending if there's text OR an image
            if (!txt && !selectedImageBase64) return;

            // Display Sent Message
            if (selectedImageBase64) {
                // Show image thumbnail in chat
                const imgPreview = `<img src="${selectedImageBase64}" style="max-width:100%; border-radius:8px; margin-bottom:5px;">`;
                if (txt) addMsg(imgPreview + `<p>${txt}</p>`, 'sent', true);
                else addMsg(imgPreview, 'sent', true);
            } else {
                addMsg(txt, 'sent');
            }

            inp.value = "";
            setTyping(true); // Indicate IA is thinking

            try {
                const payload = {
                    message: txt || "Describe esta imagen",
                    userId: currentUser.id,
                };

                if (selectedImageBase64) {
                    payload.image = selectedImageBase64;
                }

                const { data, error } = await supaClient.functions.invoke('chat', {
                    body: payload
                });

                if (error) throw error;

                // Clear image after success
                selectedImageBase64 = null;
                document.querySelector('.wa-send svg').style.stroke = 'white'; // Reset icon color
                document.getElementById('chat-image-upload').value = ""; // Reset input

                // Add a small delay for realism
                setTimeout(() => {
                    setTyping(false);
                    addMsg(marked.parse(data.response), 'received', true);
                }, 1000);
            } catch (err) {
                setTyping(false);
                addMsg("Error: " + err.message, 'received');
            }
        }

        function addMsg(txt, type, html = false) {
            const box = document.getElementById('chat-box');
            const d = document.createElement('div');
            d.className = `wa-msg ${type}`;
            if (html) d.innerHTML = txt;
            else d.innerText = txt;
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;

            // Small animation for the bubble
            gsap.from(d, { scale: 0.8, opacity: 0, duration: 0.3, ease: "back.out(1.7)" });
        }

        function toggleMode() {
            isSignUpMode = !isSignUpMode;
            const btn = document.querySelector('#step-login button');
            const link = document.getElementById('toggle-link');

            if (isSignUpMode) {
                btn.innerText = "REGISTRARSE";
                link.innerText = "Volver al Login";
            } else {
                btn.innerText = "ENTRAR";
                link.innerText = "Registrarse";
            }
        }
        function show(id) {
            ['step-login', 'step-verify', 'step-recover', 'step-newpass', 'step-recover-verify'].forEach(x => {
                const el = document.getElementById(x);
                if (el) el.style.display = 'none';
            });
            document.getElementById(id).style.display = 'block';
        }
        function showRecover() { show('step-recover'); }
        function showLogin() { isSignUpMode = false; show('step-login'); }
    </script>
</body>

</html>